# æ·»åŠ è½¬å‘
é€šè¿‡åŸŸåè¿æ¥æœ¬åœ°MySQLæœåŠ¡ï¼Œæ ¸å¿ƒæ€è·¯æ˜¯è®©åŸŸåè§£æåˆ°ä½ çš„é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼Œå¹¶åˆ©ç”¨è¿™å°æœåŠ¡å™¨ä½œä¸ºâ€œæ¡¥æ¢â€ï¼Œå°†æ”¶åˆ°çš„MySQLè¿æ¥è¯·æ±‚ï¼ˆé€šå¸¸æ˜¯3306ç«¯å£ï¼‰å®‰å…¨ã€ç¨³å®šåœ°è½¬å‘åˆ°ä½ æœ¬åœ°æœºå™¨çš„MySQLæœåŠ¡ç«¯å£ä¸Šã€‚

è¿™é€šå¸¸å¯ä»¥é€šè¿‡ç«¯å£è½¬å‘æˆ–å†…ç½‘ç©¿é€æ¥å®ç°ã€‚ç”±äºä½ æåˆ°é˜¿é‡Œäº‘æœºå™¨èƒ½è®¿é—®æœ¬åœ°æœºå™¨ï¼Œç«¯å£è½¬å‘æ˜¯æ›´ç›´æ¥å’Œç»æµçš„æ–¹å¼ã€‚å¦‚æœç½‘ç»œç¯å¢ƒå¤æ‚ï¼ˆä¾‹å¦‚æœ¬åœ°NATåï¼‰ï¼Œåˆ™å¯ä»¥é…åˆå†…ç½‘ç©¿é€å·¥å…·ã€‚

ä¸‹é¢æˆ‘ä¸ºä½ è¯´æ˜å…·ä½“çš„æ“ä½œæ­¥éª¤å’Œæ³¨æ„äº‹é¡¹ã€‚

ğŸ”§ æ“ä½œæ­¥éª¤
ä»¥ä¸‹æ˜¯å®ç°åŸŸåè®¿é—®æœ¬åœ°MySQLçš„ä¸»è¦æ­¥éª¤ï¼š

æ­¥éª¤	æ“ä½œå†…å®¹	è¯´æ˜
1	ç¡®ä¿æœ¬åœ°MySQLå¯è¢«è¿œç¨‹è®¿é—®	ä¿®æ”¹MySQLé…ç½®å’Œç”¨æˆ·æƒé™ï¼Œå…è®¸ä»é˜¿é‡Œäº‘æœåŠ¡å™¨è¿æ¥
2	é…ç½®åŸŸåè§£æ	å°†ä½ çš„åŸŸåè§£æåˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨çš„å…¬ç½‘IP
3	åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Šè®¾ç½®ç«¯å£è½¬å‘	ä½¿ç”¨å¦‚iptablesæˆ–rinetdç­‰å·¥å…·å°†3306ç«¯å£çš„æµé‡è½¬å‘åˆ°æœ¬åœ°MySQL
4	é…ç½®é˜¿é‡Œäº‘å®‰å…¨ç»„	å¼€æ”¾é˜¿é‡Œäº‘æœåŠ¡å™¨3306ç«¯å£çš„å…¥ç«™è®¿é—®
5	æµ‹è¯•è¿æ¥	ä½¿ç”¨MySQLå®¢æˆ·ç«¯é€šè¿‡åŸŸåè¿æ¥ï¼ŒéªŒè¯æ˜¯å¦æˆåŠŸ
ä¸‹é¢æ˜¯æ¯ä¸ªæ­¥éª¤çš„è¯¦ç»†è¯´æ˜ï¼š

1. é…ç½®æœ¬åœ°MySQLå…è®¸è¿œç¨‹è¿æ¥
   é¦–å…ˆç¡®ä¿ä½ çš„æœ¬åœ°MySQLæ•°æ®åº“å…è®¸æ¥è‡ªé˜¿é‡Œäº‘æœåŠ¡å™¨çš„è¿œç¨‹è¿æ¥ã€‚

ä¿®æ”¹MySQLé…ç½®ç»‘å®šåœ°å€ï¼šæ‰¾åˆ°MySQLçš„é…ç½®æ–‡ä»¶ï¼ˆå¦‚ my.cnf æˆ– my.iniï¼‰ï¼Œå°† bind-address é¡¹ä¿®æ”¹ä¸º 0.0.0.0ï¼ˆå…è®¸æ‰€æœ‰IPè¿æ¥ï¼‰æˆ–ä½ çš„æœ¬åœ°å±€åŸŸç½‘IPåœ°å€ï¼ˆæ›´å®‰å…¨ï¼‰ã€‚

ini
bind-address = 0.0.0.0
æˆæƒè¿œç¨‹è®¿é—®ç”¨æˆ·ï¼šç™»å½•MySQLï¼Œä¸ºç”¨æˆ·ï¼ˆå¦‚rootï¼‰æˆäºˆä»é˜¿é‡Œäº‘æœåŠ¡å™¨IPè¿æ¥çš„æƒé™ã€‚

sql
GRANT ALL PRIVILEGES ON *.* TO 'root'@'é˜¿é‡Œäº‘æœåŠ¡å™¨IP' IDENTIFIED BY 'ä½ çš„å¯†ç ' WITH GRANT OPTION;
FLUSH PRIVILEGES;
å¦‚æœå¸Œæœ›å…è®¸ä»ä»»ä½•ä¸»æœºè¿æ¥ï¼Œå¯ä»¥ä½¿ç”¨ '%'ï¼Œä½†è¿™ä¼šé™ä½å®‰å…¨æ€§ã€‚

é‡å¯MySQLæœåŠ¡ï¼šä¿®æ”¹é…ç½®åé‡å¯MySQLä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚

bash
sudo systemctl restart mysql
2. è®¾ç½®åŸŸåè§£æ
   å°†ä½ å·²ç»‘å®šåˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨çš„åŸŸåï¼Œé€šè¿‡DNSè§£æåˆ°è¯¥æœåŠ¡å™¨çš„å…¬ç½‘IPåœ°å€ã€‚

åœ¨ä½ çš„åŸŸåæœåŠ¡å•†ç®¡ç†åå°æ·»åŠ ä¸€æ¡ Aè®°å½•ã€‚

ä¸»æœºè®°å½•ï¼šæ ¹æ®ä½ çš„éœ€æ±‚å¡«å†™ï¼ˆä¾‹å¦‚ mysql æˆ– @ ç›´æ¥è§£æä¸»åŸŸåï¼‰ã€‚

è®°å½•å€¼ï¼šå¡«å†™ä½ çš„é˜¿é‡Œäº‘æœåŠ¡å™¨çš„å…¬ç½‘IPåœ°å€ã€‚

DNSè§£æç”Ÿæ•ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶ã€‚

3. åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Šé…ç½®ç«¯å£è½¬å‘
   ç”±äºä½ çš„é˜¿é‡Œäº‘æœåŠ¡å™¨èƒ½è®¿é—®æœ¬åœ°æœºå™¨ï¼Œå¯ä»¥åœ¨å…¶ä¸Šè®¾ç½®ç«¯å£è½¬å‘ï¼Œå°†æ”¶åˆ°3306ç«¯å£çš„è¯·æ±‚è½¬å‘åˆ°æœ¬åœ°æœºå™¨çš„MySQLæœåŠ¡ã€‚

ä»¥ä½¿ç”¨ iptables ä¸ºä¾‹ï¼š

bash
# å¯ç”¨IPè½¬å‘
sudo sysctl -w net.ipv4.ip_forward=1

# æ·»åŠ iptablesè§„åˆ™å°†åˆ°è¾¾æœ¬æœº3306çš„æµé‡è½¬å‘åˆ°æœ¬åœ°æœºå™¨çš„MySQLç«¯å£
```shell
sudo iptables -t nat -A PREROUTING -p tcp --dport 3306 -j DNAT --to-destination 100.95.91.54:3306
sudo iptables -t nat -A POSTROUTING -j MASQUERADE

```
# ä¿å­˜iptablesè§„åˆ™ï¼ˆå…·ä½“å‘½ä»¤å–å†³äºä½ çš„æ“ä½œç³»ç»Ÿï¼‰
ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´æ–¹ä¾¿çš„å·¥å…·å¦‚ rinetd è¿›è¡Œè½¬å‘ã€‚

4. é…ç½®é˜¿é‡Œäº‘æœåŠ¡å™¨å®‰å…¨ç»„
   ç¡®ä¿é˜¿é‡Œäº‘æœåŠ¡å™¨çš„å®‰å…¨ç»„è§„åˆ™å…è®¸å¤–éƒ¨è®¿é—®3306ç«¯å£ã€‚

ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°ï¼Œæ‰¾åˆ°ä½ çš„ECSå®ä¾‹ã€‚

è¿›å…¥å®‰å…¨ç»„é…ç½®ï¼Œæ·»åŠ ä¸€æ¡å…¥æ–¹å‘è§„åˆ™ï¼š

æˆæƒç­–ç•¥: å…è®¸

åè®®ç±»å‹: TCP

ç«¯å£èŒƒå›´: 3306/3306

æˆæƒå¯¹è±¡: 0.0.0.0/0ï¼ˆå…è®¸æ‰€æœ‰IPè®¿é—®ï¼Œå»ºè®®æµ‹è¯•åæ”¹ä¸ºæ›´å…·ä½“çš„IPæ®µä»¥æé«˜å®‰å…¨æ€§ï¼‰

5. æµ‹è¯•è¿æ¥
   ä½¿ç”¨MySQLå®¢æˆ·ç«¯å·¥å…·ï¼ˆå¦‚mysqlå‘½ä»¤è¡Œã€Navicatã€Workbenchç­‰ï¼‰ï¼Œé€šè¿‡åŸŸåè€ŒéIPåœ°å€æ¥è¿æ¥ä½ çš„MySQLæ•°æ®åº“ã€‚

bash
mysql -h mysql.ydphoto.com -u root -p
å¦‚æœè¿æ¥æˆåŠŸï¼Œè¯´æ˜é…ç½®å·²å®Œæˆã€‚

âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹
å®‰å…¨ç¬¬ä¸€ï¼šå°†MySQLæœåŠ¡æš´éœ²åˆ°å…¬ç½‘ä¼šå¢åŠ é£é™©ã€‚é™¤äº†ä½¿ç”¨å¼ºå¯†ç ï¼Œè¿˜åº”ï¼š

è€ƒè™‘ä½¿ç”¨SSHéš§é“ï¼šè¿™æ˜¯ä¸€ç§æ›´å®‰å…¨çš„æ–¹å¼ï¼Œé€šè¿‡åŠ å¯†çš„SSHè¿æ¥è®¿é—®MySQLï¼Œæ— éœ€ç›´æ¥å¼€æ”¾3306ç«¯å£ã€‚

é™åˆ¶è®¿é—®æºIPï¼šåœ¨é˜¿é‡Œäº‘å®‰å…¨ç»„å’ŒMySQLæˆæƒä¸­ï¼Œå°½é‡ä¸è¦ä½¿ç”¨%ï¼Œè€Œæ˜¯æŒ‡å®šå…è®¸è¿æ¥çš„ç‰¹å®šIPæˆ–IPæ®µã€‚

å®šæœŸæ›´æ–°å¯†ç ã€‚

é˜²ç«å¢™è®¾ç½®ï¼šç¡®ä¿ä½ çš„æœ¬åœ°æœºå™¨é˜²ç«å¢™ä¹Ÿå…è®¸æ¥è‡ªé˜¿é‡Œäº‘æœåŠ¡å™¨çš„3306ç«¯å£çš„å…¥ç«™è¿æ¥ã€‚

æ€§èƒ½è€ƒè™‘ï¼šç»è¿‡é˜¿é‡Œäº‘æœåŠ¡å™¨è½¬å‘å¯èƒ½ä¼šå¢åŠ å°‘è®¸ç½‘ç»œå»¶è¿Ÿï¼Œä½†å¯¹äºå¤§å¤šæ•°åº”ç”¨æ¥è¯´åº”è¯¥å¯ä»¥æ¥å—ã€‚

DNSè§£æï¼šç¡®ä¿åŸŸåå·²æ­£ç¡®è§£æåˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨çš„å…¬ç½‘IPï¼Œå¯é€šè¿‡ ping ä½ çš„åŸŸå æ£€æŸ¥ã€‚

æœåŠ¡ç¨³å®šæ€§ï¼šå¦‚æœä½ çš„æœ¬åœ°æœºå™¨IPæ˜¯åŠ¨æ€åˆ†é…çš„ï¼ŒIPå˜åŒ–ä¼šå¯¼è‡´è½¬å‘å¤±è´¥ã€‚è€ƒè™‘ä½¿ç”¨DDNSæœåŠ¡ï¼Œæˆ–è€…æ¢ç´¢æ›´ç¨³å®šçš„å†…ç½‘ç©¿é€æ–¹æ¡ˆã€‚

ğŸ’¡ å¤‡é€‰æ–¹æ¡ˆï¼šå†…ç½‘ç©¿é€å·¥å…·
å¦‚æœä½ çš„ç½‘ç»œç¯å¢ƒæ¯”è¾ƒå¤æ‚ï¼ˆä¾‹å¦‚æœ¬åœ°æœºå™¨æ²¡æœ‰å…¬ç½‘IPä¸”å¤„äºå¤šå±‚NATä¹‹åï¼‰ï¼Œæˆ–è€…å¸Œæœ›ç®€åŒ–ç«¯å£è½¬å‘è§„åˆ™çš„é…ç½®ï¼Œå¯ä»¥å°è¯•å†…ç½‘ç©¿é€å·¥å…·ï¼ˆå¦‚frpã€ngrokã€cpolarç­‰ï¼‰ã€‚

åœ¨æœ¬åœ°æœºå™¨ï¼šå®‰è£…å†…ç½‘ç©¿é€å®¢æˆ·ç«¯ï¼Œå¹¶é…ç½®å°†æœ¬åœ°3306ç«¯å£æ˜ å°„åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨çš„æŸä¸ªç«¯å£ã€‚

åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼šå®‰è£…å†…ç½‘ç©¿é€æœåŠ¡ç«¯ï¼ˆå¦‚æœæ˜¯frpç­‰è‡ªå»ºå·¥å…·ï¼‰ã€‚

è¿æ¥æ—¶ï¼šMySQLå®¢æˆ·ç«¯è¿æ¥é˜¿é‡Œäº‘æœåŠ¡å™¨çš„å…¬ç½‘IPå’ŒæŒ‡å®šçš„æ˜ å°„ç«¯å£ã€‚

è®¸å¤šå†…ç½‘ç©¿é€å·¥å…·æä¾›äº†æ›´ç®€å•çš„é…ç½®æ–¹å¼å’Œç¨³å®šçš„è¿æ¥ã€‚

ğŸ’ æ€»ç»“
é€šè¿‡åŸŸåè®¿é—®æœ¬åœ°MySQLæœåŠ¡çš„æ ¸å¿ƒï¼Œæ˜¯åˆ©ç”¨é˜¿é‡Œäº‘æœåŠ¡å™¨ä½œä¸ºä¸­è½¬ï¼Œé€šè¿‡ç«¯å£è½¬å‘å°†åŸŸåçš„è¯·æ±‚æœ€ç»ˆæŒ‡å‘æœ¬åœ°MySQLã€‚å…³é”®æ˜¯ç¡®ä¿MySQLå…è®¸è¿œç¨‹è¿æ¥ã€åŸŸåè§£ææ­£ç¡®ã€é˜¿é‡Œäº‘å®‰å…¨ç»„å¼€æ”¾ç«¯å£ï¼Œå¹¶åœ¨æœåŠ¡å™¨ä¸Šé…ç½®å¥½è½¬å‘è§„åˆ™ã€‚

å®‰å…¨æ˜¯é¦–è¦è€ƒè™‘ï¼ŒåŠ¡å¿…åšå¥½æƒé™æ§åˆ¶å’Œè®¿é—®é™åˆ¶ã€‚

å¸Œæœ›è¿™äº›ä¿¡æ¯èƒ½å¸®åˆ°ä½ ã€‚å¦‚æœä½ åœ¨å…·ä½“æ“ä½œæ­¥éª¤ä¸­é‡åˆ°é—®é¢˜ï¼Œæ¬¢è¿å†æ¥é—®ã€‚

å¾ˆå¥½ ğŸ‘
ä¸‹é¢æ˜¯ä¸€ä»½é€‚ç”¨äº Linux ç³»ç»Ÿï¼ˆå¦‚ Ubuntuã€CentOS ç­‰ï¼‰çš„ å¼€æœºè‡ªåŠ¨åŠ è½½ IP è½¬å‘ä¸ iptables è§„åˆ™ çš„å®Œæ•´é…ç½®æ–¹æ³•ã€‚

ğŸ“ ä¸€ã€å‡†å¤‡è§„åˆ™æ–‡ä»¶

å…ˆæ‰‹åŠ¨æ·»åŠ è§„åˆ™ï¼ˆä½ ä¹‹å‰å·²ç»æ‰§è¡Œè¿‡ï¼‰ï¼š

sudo sysctl -w net.ipv4.ip_forward=1

sudo iptables -t nat -A PREROUTING -p tcp --dport 3306 \
-j DNAT --to-destination 100.21.23.45:3306

sudo iptables -t nat -A POSTROUTING -j MASQUERADE


# ä¿å­˜è§„åˆ™åˆ°æ–‡ä»¶ï¼š

sudo sh -c 'iptables-save > /etc/iptables.rules'

âš™ï¸ äºŒã€è®¾ç½®å¼€æœºåŠ è½½è§„åˆ™
æ–¹æ³• Aï¼šä½¿ç”¨ rc.localï¼ˆæœ€ç®€å•é€šç”¨ï¼‰

ç¼–è¾‘ /etc/rc.local æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨å°±åˆ›å»ºï¼‰ï¼š

sudo nano /etc/rc.local


å†™å…¥ä»¥ä¸‹å†…å®¹ï¼š

#!/bin/bash
# å¼€å¯IPè½¬å‘
sysctl -w net.ipv4.ip_forward=1

# æ¢å¤iptablesè§„åˆ™
iptables-restore < /etc/iptables.rules

exit 0


ç»™äºˆå¯æ‰§è¡Œæƒé™ï¼š

sudo chmod +x /etc/rc.local


å¦‚æœç³»ç»Ÿæ˜¯ systemdï¼ˆå¤§å¤šæ•°ç°ä»£ç³»ç»Ÿéƒ½æ˜¯ï¼‰ï¼Œç¡®ä¿ rc-local æœåŠ¡å¯ç”¨ï¼š

sudo systemctl enable rc-local
sudo systemctl start rc-local

æ–¹æ³• Bï¼šä½¿ç”¨ systemd è‡ªå®šä¹‰æœåŠ¡ï¼ˆæ›´æ ‡å‡†ï¼‰

å¦‚æœä½ æƒ³ç”¨æ›´è§„èŒƒçš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ª systemd æœåŠ¡ï¼š

åˆ›å»ºæœåŠ¡æ–‡ä»¶ï¼š

sudo nano /etc/systemd/system/iptables-restore.service


å†…å®¹å¦‚ä¸‹ï¼š

[Unit]
Description=Restore iptables rules at boot
After=network.target

[Service]
Type=oneshot
ExecStartPre=/sbin/sysctl -w net.ipv4.ip_forward=1
ExecStart=/bin/bash -c '/sbin/iptables-restore < /etc/iptables.rules'
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target


é‡æ–°åŠ è½½ systemd å¹¶å¯ç”¨æœåŠ¡ï¼š

sudo systemctl daemon-reload
sudo systemctl enable iptables-restore
sudo systemctl start iptables-restore

âœ… ä¸‰ã€éªŒè¯

é‡å¯åæ£€æŸ¥ï¼š

cat /proc/sys/net/ipv4/ip_forward
# åº”è¾“å‡º 1

sudo iptables -t nat -L -n -v
# åº”èƒ½çœ‹åˆ° PREROUTING å’Œ POSTROUTING çš„è§„åˆ™
